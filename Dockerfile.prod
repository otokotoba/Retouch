# syntax=docker/dockerfile:1

ARG NODE_VERSION=$(cat .node-version)
FROM node:${NODE_VERSION}-slim

# Create app directory
WORKDIR /app

# Copy package.json and package-lock.json
COPY package*.json ./

# Install packages
RUN --mount=type=cache,id=npm,target=/root/.npm npm ci --omit=dev

# Copy the app code
COPY . .

# Build the project
ARG CONFIG
RUN --mount=type=secret,id=config,target=/app/config/config.json <<EOF
  mkdir config
  echo $CONFIG | base64 --decode > config/config.json
EOF
RUN npm run build

# Expose ports
EXPOSE 3001

# Run the application
CMD [ "node", "dist/start-manager.js" ]
